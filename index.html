<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Street Soccer – Dashboard</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    /* Toast */
    @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
    @keyframes fadeOut { from {opacity:1;} to {opacity:0;} }
    .toast {
      position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
      padding:12px 24px; border-radius:8px; color:#fff; font-size:14px;
      box-shadow:0 4px 12px rgba(0,0,0,.3); z-index:9999;
      animation:fadeIn .3s, fadeOut .3s 2.7s forwards;
    }
    .toast.success {background:#2e7d32;}
    .toast.error   {background:#d32f2f;}
    .toast.info    {background:#1a1a1a;}
  </style>
</head>

<body data-page="dashboard">
<main class="container">
  <header class="card">
    <h1>Street Soccer Dashboard</h1>
  </header>

  <section class="card">
    <h2>Stats</h2>
    <div class="grid grid-3">
      <div><strong>Teams</strong><br><span id="statTeams">0</span></div>
      <div><strong>Players</strong><br><span id="statPlayers">0</span></div>
      <div><strong>Matches</strong><br><span id="statMatches">0</span></div>
    </div>
  </section>

  <!-- GitHub sync will be injected here by JS -->
</main>

<script>
/*=====================================================================
  ALL CODE – NO EXTERNAL script.js → byId is defined first
=====================================================================*/

const store = {
  get(k, fb){ try{return JSON.parse(localStorage.getItem(k))??fb;}catch(e){return fb;} },
  set(k, v){ localStorage.setItem(k, JSON.stringify(v)); window.dispatchEvent(new Event('storage')); }
};

const uuid = ()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
const byId = id=>document.getElementById(id);               // ← DEFINED HERE

/* ---------- GITHUB CONFIG ---------- */
let GITHUB_TOKEN = localStorage.getItem('ghToken')||'';
let GITHUB_REPO  = localStorage.getItem('ghRepo')||'';
const GITHUB_PATH = 'data.json';

function ghRawUrl(){
  if(!GITHUB_REPO) return '';
  const raw = `https://raw.githubusercontent.com/${GITHUB_REPO}/main/${GITHUB_PATH}`;
  return `https://corsproxy.io/?${encodeURIComponent(raw)}`;
}
function ghApiUrl(){ return `https://api.github.com/repos/${GITHUB_REPO}/contents/${GITHUB_PATH}`; }

/* ---------- TOAST ---------- */
function toast(msg, type='info'){
  const el = document.createElement('div');
  el.className=`toast ${type}`;
  el.textContent=msg;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),3000);
}

/* ---------- AUTO-LOAD ---------- */
async function autoLoad(){
  if(!GITHUB_REPO) return;
  try{
    const r = await fetch(ghRawUrl(),{cache:'no-store'});
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const data = await r.json();
    ['teams','players','matches','bracket'].forEach(k=>data[k]!==undefined && store.set(k,data[k]));
    toast('Data loaded from GitHub','success');
  }catch(e){
    toast(`Load failed: ${e.message}`,'error');
  }
}

/* ---------- SAVE ---------- */
async function saveToGitHub(){
  if(!GITHUB_TOKEN||!GITHUB_REPO) return toast('Set repo & token','error');
  try{
    let sha=null;
    try{
      const cur=await fetch(ghApiUrl(),{headers:{'Authorization':`token ${GITHUB_TOKEN}`}}).then(r=>r.json());
      sha=cur.sha;
    }catch{}
    const payload={message:`Update ${new Date().toISOString()}`,branch:'main',
      content:btoa(JSON.stringify({
        teams:store.get('teams',[]),
        players:store.get('players',{}),
        matches:store.get('matches',[]),
        bracket:store.get('bracket',{rounds:[]})
      },null,2))};
    if(sha) payload.sha=sha;
    const res=await fetch(ghApiUrl(),{
      method:sha?'PUT':'POST',
      headers:{'Authorization':`token ${GITHUB_TOKEN}`,'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });
    if(!res.ok) throw new Error(`Save failed ${res.status}`);
    toast('Saved to GitHub!','success');
  }catch(e){toast('Save error: '+e.message,'error');}
}

/* ---------- DATA HELPERS ---------- */
const getTeams   =()=>store.get('teams',[]);
const setTeams   =v=>store.set('teams',v);
const getPlayers =()=>store.get('players',{});
const setPlayers =v=>store.set('players',v);
const getMatches =()=>store.get('matches',[]);
const setMatches =v=>store.set('matches',v);
const getBracket =()=>store.get('bracket',{rounds:[]});
const setBracket =v=>store.set('bracket',v);

const fileToDataURL = f=>new Promise(r=>{if(!f)return r('');const rd=new FileReader();rd.onload=()=>r(rd.result);rd.readAsDataURL(f);});

/* ---------- DASHBOARD ---------- */
function initDashboard(){
  const updateStats=()=>{
    const teams=getTeams().length;
    const players=Object.values(getPlayers()).reduce((s,a)=>s+(Array.isArray(a)?a.length:0),0);
    const matches=getMatches().length;
    byId('statTeams').textContent=teams;
    byId('statPlayers').textContent=players;
    byId('statMatches').textContent=matches;
  };
  updateStats();
  window.addEventListener('storage',updateStats);

  const sec=document.createElement('section');
  sec.className='card';
  sec.innerHTML=`
    <h2>GitHub Live Sync (Admin)</h2>
    <div class="grid grid-3">
      <div><label>Repo</label><input id="ghRepo" value="${GITHUB_REPO}" placeholder="user/repo"></div>
      <div><label>Token</label><input id="ghToken" type="password" value="${GITHUB_TOKEN}" placeholder="ghp_…"></div>
      <div class="full actions" style="margin-top:1rem;">
        <button class="btn sm primary" id="ghSave">Save to GitHub</button>
        <button class="btn sm" id="ghClear">Clear</button>
      </div>
    </div>
    <p style="font-size:.8rem;margin-top:.5rem;color:#aaa;">
      Data auto-loads on every page. Token needed only to save.
    </p>`;
  document.querySelector('main.container').appendChild(sec);

  byId('ghSave').onclick=()=>{
    const repo=byId('ghRepo').value.trim();
    const token=byId('ghToken').value.trim();
    if(!repo) return toast('Enter repo','error');
    localStorage.setItem('ghRepo',repo);
    localStorage.setItem('ghToken',token);
    GITHUB_REPO=repo; GITHUB_TOKEN=token;
    saveToGitHub();
  };
  byId('ghClear').onclick=()=>{
    localStorage.removeItem('ghRepo');
    localStorage.removeItem('ghToken');
    GITHUB_REPO=''; GITHUB_TOKEN='';
    byId('ghRepo').value=''; byId('ghToken').value='';
    toast('Config cleared','info');
  };
}

/* ---------- BOOT ---------- */
document.addEventListener('DOMContentLoaded',()=>{
  autoLoad().then(()=>initDashboard());
});
</script>
</body>
</html>